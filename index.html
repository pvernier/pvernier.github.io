<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="WHO, OMS">
    <title>WHO - IRAQ</title>

    <link href="code/src/bootstrap-3.3.4-dist/css/bootstrap.min.css" rel="stylesheet"> 
    
    <link rel="stylesheet" href="code/src/leaflet/leaflet.css"/>
    <link rel="stylesheet" href="code/src/leaflet/leaflet.label.css" />
    <link rel="stylesheet" href="code/src/nvd3-master/build/nv.d3.min.css" />
    <link rel="stylesheet" href="code/src/leaflet/markercluster/MarkerCluster.css" />
    <link rel="stylesheet" href="code/src/leaflet/markercluster/MarkerCluster.Default.css" />

    <link rel="stylesheet" href="code/css/style.css"/>

    <script src="code/src/jquery-2.1.1.min.js"></script>
    
    <script src="code/src/leaflet/leaflet.js"></script>
    <script src="code/src/leaflet/leaflet.label.js"></script>
    <script src="code/src/nvd3-master/d3.min.js"></script>
    <script src="code/src/nvd3-master/build/nv.d3.min.js"></script> 
    <script src="code/src/leaflet/markercluster/leaflet.markercluster-src.js"></script>
    <script src="code/src/simple_statistics.min.js"></script>
    <script src="code/src/turf.min.js"></script>

    <script src='code/data/layers/countries.geojson'></script>
    <script src='code/data/layers/health_districts.geojson'></script>
    <script src='code/data/layers/health_provinces.geojson'></script> 

   
     
          
  </head>
  <body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="index.html">WHO - IRAQ - EWARN</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <!-- <ul class="nav navbar-nav">
            <li><a href="index.html"><span class="glyphicon glyphicon glyphicon-globe" aria-hidden="true"></span>  Maps</a></li>
            <li><a href="charts.html"><span class="glyphicon glyphicon glyphicon-signal" aria-hidden="true"></span>  Charts</a></li>
          </ul> -->
        </div>
      </div>
    </nav>
    </br>
    
    <div class="row">
        <div id="text" class="col-md-2">
            <div id="donuts">
                    <h6>DISTRIBUTION OF ACUTE RESPIRATORY INFECTIONS (ARI)</h6>
                    <div class="donut" id="donut1">
                        <svg></svg>
                    </div>
                    <h6>PERCENTAGE OF REPORTED CASES BY AGE</h6>
                    <div class="donut" id="donut2">
                        <svg></svg>
                    </div>
                    <h6>TOTAL REPORTED CASES BY GENDER</h6>
                    <div class="donut" id="donut3">
                        <svg></svg>
                    </div>
            </div>
        </div>
         <div id="map" class="col-md-7"></div>
         <div id="numbers" class="col-md-3">
                 <h5 class="title_dis">Number of diseases</h5>
                 <ul class="dis_list"></ul>
                 <h5 class="title_alert">Number of alerts</h5>
                 <ul class="alert_list"></ul>
            </div>
    </div>
    <div class="row">
        <div id="map" class="col-md-6">
            <h3>Total Consultations and Number of Reporting Sites by Week</h3>
            <div id="chart_main" style="height: 400px; margin: 0 auto;">
                <svg></svg>
            </div>
        </div>
        <div class="col-md-6">
            <h3 id="chart_title">Trend of proportion of cases of ARI, Scabies and AD in <select id="trends"><option value="1">All camps</option><option value="2">IDP camps</option><option value="3">Refugee camps</option></select></h3>
                <div id="chart_gtrend" style="height: 400px; margin: 0 auto;">
                    <svg></svg>
                </div> 
        </div>
    </div>
    
<script>
 $(document).ready(function() {
     // timestamps will contain the week numbers
     var timestamps = []; 
     var map = L.map('map', { 
            center: [33.3, 43.5], 
            zoom: 6,    
            minZoom: 6,
            maxZoom: 18  
        });

    var cons_Ad = (function () {
        var json = null;
        $.ajax({
            'async': false,
            'global': false,
            'url': 'code/data/Ad_per_week.geojson',
            'dataType': "json",
            'success': function (data) {
                json = data;
            }
        });
        return json;
    })(); 

    var cons_all = (function () {
        var json = null;
        $.ajax({
            'async': false,
            'global': false,
            'url': 'code/data/all_per_week.geojson',
            'dataType': "json",
            'success': function (data) {
                json = data;
                // I fill in timestamps
                for (var feature in data.features) {    
                    var properties = data.features[feature].properties; 

                    for (var attribute in properties) { 
                        if ( attribute != 'id' &&   
                             attribute != 'name') 
                        {
                            if ( $.inArray(attribute,timestamps) ===  -1) { 
                                timestamps.push(attribute);
                            }  
                        }
                    }
                }
            }
        });
        return json;
    })(); 

    var cons_Skin = (function () {
        var json = null;
        $.ajax({
            'async': false,
            'global': false,
            'url': 'code/data/Skin_per_week.geojson',
            'dataType': "json",
            'success': function (data) {
                json = data;
            }
        });
        return json;
    })(); 

    var cons_Lrti = (function () {
        var json = null;
        $.ajax({
            'async': false,
            'global': false,
            'url': 'code/data/Lrti_per_week.geojson',
            'dataType': "json",
            'success': function (data) {
                json = data;
            }
        });
        return json;
    })();

    var cons_Urti = (function () {
        var json = null;
        $.ajax({
            'async': false,
            'global': false,
            'url': 'code/data/Urti_per_week.geojson',
            'dataType': "json",
            'success': function (data) {
                json = data;
            }
        });
        return json;
    })();

    var OpenStreetMap_HOT = L.tileLayer('http://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Tiles courtesy of <a href="http://hot.openstreetmap.org/" target="_blank">Humanitarian OpenStreetMap Team</a>'
    });
        var hdists = L.geoJson(health_districts, {
            style: function (feature) {
                return {fillColor: "#ffffbf",
                        color: "#d8b365",
                        weight: 0.8,
                        opacity: 0.8,
                        fillOpacity: .7};
            },
            onEachFeature: function (feature, layer) {
                layer.bindPopup(feature.properties.name, {autoPan: false});
            }
        });
        var countries = L.geoJson(countr, {
            style: function (feature) {
                return {fillColor: "white",
                        color: "black",
                        weight: 1,
                        opacity: 0.8,
                        fillOpacity: 0.8};
            }
        });
        var hprovs = L.geoJson(health_provinces, {
            style: function (feature) {
                return {color: "#8A4117",
                        weight: 1,
                        opacity: 0.8};
            }
        });

        var baseLayers = L.layerGroup([countries, hdists, hprovs]).addTo(map);
        
        var labelIran= new L.Label();
        labelIran.setContent("<em>IRAN</em>");
        labelIran.setLatLng([33.8, 48.5]);
        map.showLabel(labelIran);
        
        var labelSyriq = new L.Label();
        labelSyriq.setContent("<em>SYRIA</em>");
        labelSyriq.setLatLng([35, 38]);
        map.showLabel(labelSyriq);

        var labelJordan = new L.Label();
        labelJordan.setContent('<em>JORDAN</em>');
        labelJordan.setLatLng([31, 35.5]);
        map.showLabel(labelJordan);

        var labelKSA = new L.Label();
        labelKSA.setContent('<em>SAUDI</br>ARABIA</em>');
        labelKSA.setLatLng([30.5, 39]);
        map.showLabel(labelKSA);

        var labelTurkey = new L.Label();
        labelTurkey.setContent('<em>TURKEY</em>');
        labelTurkey.setLatLng([37.1, 38]);
        map.showLabel(labelTurkey);

        var labelKuwait = new L.Label();
        labelKuwait.setContent('<em>KUWAIT</em>');
        labelKuwait.setLatLng([29.4, 46.9]);
        map.showLabel(labelKuwait);

        var icon_large = L.icon({
        iconUrl: 'code/src/leaflet/images/class_large.png',
        iconSize: [16, 16]
        });
        var icon_medium = L.icon({
        iconUrl: 'code/src/leaflet/images/class_medium.png',
        iconSize: [16, 16]
        });
        var icon_small = L.icon({
        iconUrl: 'code/src/leaflet/images/class_small.png',
        iconSize: [16, 16]
        });
//
// Function to display the cumulative data
function show_cumulative(geojson_file) {
    console.log(geojson_file);

    $("output.temporal-legend").remove();
    $("input.range-slider").remove();
    legend.removeFrom(map);
    map.removeLayer(markers);
    markers = L.markerClusterGroup({
            iconCreateFunction: function(cluster) {
                var children = cluster.getAllChildMarkers();
                var sum = 0; 
                for (var i = 0; i < children.length; i++) {
                    sum += children[i].options.val
                }

                if (uniq_breaks.length === 4) {
                    
                    if (sum > uniq_breaks[2]) {
                        class_n = 'marker-cluster marker-cluster-large';
                    }
                    else if (sum > uniq_breaks[1] && sum <= uniq_breaks[2]){
                        class_n = 'marker-cluster marker-cluster-medium';
                    }
                    else{
                        class_n = 'marker-cluster marker-cluster-small';
                    };
                }
                else if (uniq_breaks.length === 3) {
                    if (sum > uniq_breaks[1] && sum <= uniq_breaks[2]) {
                        class_n = 'marker-cluster marker-cluster-large';
                    }
                    else if (sum > uniq_breaks[0] && sum <= uniq_breaks[1]){
                        class_n = 'marker-cluster marker-cluster-medium';
                    }
                }
                else if (uniq_breaks.length === 2) {
                    if (sum > uniq_breaks[0] && sum <= uniq_breaks[1]) {
                        class_n = 'marker-cluster marker-cluster-large';
                    }
                }
                return new L.DivIcon({ html: '<div><span>' + sum + '</span></div>', className: class_n, iconSize: L.point(40, 40) });
            },
            showCoverageOnHover: false
        });

        $.getJSON(geojson_file, function(data) {
        if (data.features.length > 1) {
            breaks = turf.jenks(data, "total", 3);
        }
        else{
            breaks = turf.jenks(data, "total", 1);
        };
        
        console.log('breaks:');
        console.log(breaks);
        // I extract the unique values from breaks 
        uniq_breaks =[];  
        for (var classe in breaks) {
            if ( $.inArray(breaks[classe], uniq_breaks) ===  -1 && typeof breaks[classe] !== "undefined") {
                uniq_breaks.push(breaks[classe]);
            }
        }
        console.log('uniq breaks:');
        console.log(uniq_breaks); 
        
        for (var i = 0; i < data.features.length; i++) {
            var coords = data.features[i].geometry.coordinates;

            var myIcon;
                
            if (uniq_breaks.length === 4) {
                
                if (data.features[i].properties.total > uniq_breaks[2]) {
                    myIcon = icon_large;
                }
                else if (data.features[i].properties.total > uniq_breaks[1] && data.features[i].properties.total <= uniq_breaks[2]) {
                    myIcon = icon_medium;
                }
                else{
                    myIcon = icon_small;
                };
            }
            else if (uniq_breaks.length === 3) {
                console.log("long 3");
                if (data.features[i].properties.total > uniq_breaks[1] && data.features[i].properties.total <= uniq_breaks[2]) {
                    myIcon = icon_large;
                }
                else {
                    myIcon = icon_medium;
                }
            }
            else if (uniq_breaks.length === 2) {
                if (data.features[i].properties.total >= uniq_breaks[0] && data.features[i].properties.total <= uniq_breaks[1]) {
                    myIcon = icon_large;
                }
            }
            // uniq_breaks.length === 1
            else {
                myIcon = icon_large;
            }

            /*var cumul_popup ="<b>" + data.features[i].properties.name + " </b><br>" + "<b>" + String(data.features[i].properties.total) +
                               "</b> consultations"*/
            var cumul_popup = '<div id="chart_camp" style="height: 200px; width: 500px; margin: 0 auto;"><svg></svg></div><b>'+ data.features[i].properties.name + ': ' + String(data.features[i].properties.total) + '</b> consultations';
            var marker = L.marker(new L.LatLng(coords[1], coords[0]), { icon: myIcon, name: data.features[i].properties.name, val: data.features[i].properties.total });
            marker.bindPopup(cumul_popup, {className: 'chart-popup'});
            //marker.bindPopup(cumul_popup, {'offset': L.point(0,-10)});

            /*marker.on('mouseover', function (e) {
                    $("em").css( "display", "none" );
                    this.openPopup();
                });
            marker.on('mouseout', function (e) {
                    $("em").css( "display", "inline" );
                    this.closePopup();
                });*/
            marker.on('click', function (e) {
                    $("em").css( "display", "none" );
                    console.log(this.options.name);
                    var camp_chart = [{"color": "#2E9AFE", "values": [], "key": "AD"},  {"color": "#FA5858", "values": [], "key": "Skin"},  {"color": "#5FB404", "values": [], "key": "ARI"}]
                     
                        for (var i = cons_Ad.features.length - 1; i >= 0; i--) {
                            if (cons_Ad.features[i].properties.name === this.options.name) {
                                for (var attribute in cons_Ad.features[i].properties) { 
                                    if (attribute != 'name') {
                                        if (cons_all.features[i].properties[attribute][0] != 0) {
                                            camp_chart[0].values.push([attribute, Math.round(cons_Ad.features[i].properties[attribute][0] / cons_all.features[i].properties[attribute][0] * 10000)/100]);
                                            camp_chart[1].values.push([attribute, Math.round(cons_Skin.features[i].properties[attribute][0] / cons_all.features[i].properties[attribute][0] * 10000)/100]);
                                            camp_chart[2].values.push([attribute,Math.round((cons_Lrti.features[i].properties[attribute][0] + cons_Urti.features[i].properties[attribute][0]) / cons_all.features[i].properties[attribute][0] * 10000)/100]);
                                        }
                                        else {
                                            camp_chart[0].values.push([attribute, 0]);
                                            camp_chart[1].values.push([attribute, 0]);
                                            camp_chart[2].values.push([attribute, 0]);
                                        }
                                    }
                                };
                            };                      
                        };
                        console.log(camp_chart);
                        $( "h2#chart_title").text("Trend of proportion of cases of ARI, Scabies and AD in " + this.options.name);
                        nv.addGraph(function() {
                            var chart = nv.models.lineChart()
                                          .x(function(d,i) {return i })
                                          .y(function(d,i) {return d[1] })
                                          //.useInteractiveGuideline(true) ;
 
                             // Custom the tooltip
                              //chart.interactiveLayer.tooltip.contentGenerator(function (key) {
                              chart.tooltip.contentGenerator(function (key) {
                                    etiquette = '<b>Week ' + key.point[0] + ' - ' + key.series[0]["key"] + '</b><table><tr><td class="legend-color-guide"><div style="background:'+ key.point.color + ';"></div></td><td>' + key.point[1] + '%</td></table>'
                                    return etiquette;
                               });
                             // To custom the x-axis label. 
                             chart.xAxis
                                .axisLabel("Weeks")
                                .tickFormat(function(d){
                                              return d + 1
                                          });
                            chart.yAxis
                                .axisLabel("Percentage")
                                .tickFormat(d3.format(',.2f'));
                                //.tickFormat(d3.format(',f'));

                            d3.select('#chart_camp svg')
                                .datum(camp_chart)
                                .call(chart);

                            nv.utils.windowResize(chart.update);
                            return chart;
                          });
                });

            markers.addLayer(marker);
        }
        map.addLayer(markers);

        add_legend();

        });
}

function extractDistrib(data) {
    distrib = []
    for (var feature in data.features) {    
        var properties = data.features[feature].properties; 

        for (var attribute in properties) { 
            if ( attribute != 'id' &&   
                 attribute != 'name') 
            {
                if (properties[attribute][0] !=0) {
                    distrib.push(properties[attribute][0]);
                }
            }
        }
    }
    if (distrib.length > 1) {
        breaks = ss.jenks(distrib, 3);
    }
    else {
        breaks = ss.jenks(distrib, 1);
    }

    // I extract the unique values from breaks 
    uniq_breaks =[];  
    for (var classe in breaks) {
        if ( $.inArray(breaks[classe], uniq_breaks) ===  -1) {
            uniq_breaks.push(breaks[classe]);
        }
    }
    console.log('uniq breaks:');
    console.log(uniq_breaks);
}

function updatePropSymbols(data, timestamp) {   
    markers = L.markerClusterGroup({
            iconCreateFunction: function(cluster) {
                var children = cluster.getAllChildMarkers();
                var sum = 0;

                for (var i = 0; i < children.length; i++) {
                        sum += children[i].options.val
                    }
                if (uniq_breaks.length === 4) {
                    
                    if (sum > uniq_breaks[2]) {
                        class_n = 'marker-cluster marker-cluster-large';
                    }
                    else if (sum > uniq_breaks[1] && sum <= uniq_breaks[2]){
                        class_n = 'marker-cluster marker-cluster-medium';
                    }
                    else{
                        class_n = 'marker-cluster marker-cluster-small';
                    };
                }
                else if (uniq_breaks.length === 3) {
                    if (sum > uniq_breaks[1] && sum <= uniq_breaks[2]) {
                        class_n = 'marker-cluster marker-cluster-large';
                    }
                    else if (sum > uniq_breaks[0] && sum <= uniq_breaks[1]){
                        class_n = 'marker-cluster marker-cluster-medium';
                    }
                }
                else if (uniq_breaks.length === 2) {
                    if (sum > uniq_breaks[0] && sum <= uniq_breaks[1]) {
                        class_n = 'marker-cluster marker-cluster-large';
                    }
                }
                // uniq_breaks.length === 1
                else {
                    class_n = 'marker-cluster marker-cluster-large';
                }
                return new L.DivIcon({ html: '<div><span>' + sum + '</span></div>', className: class_n, iconSize: L.point(40, 40) });
            },
            showCoverageOnHover: false
        });

    for (var i = 0; i < data.features.length; i++) {
         if (data.features[i].properties[timestamp][0] != 0) {
                var coords = data.features[i].geometry.coordinates;

                var myIcon;
                
                if (uniq_breaks.length === 4) {
                    
                    if (data.features[i].properties[timestamp][0] > uniq_breaks[2]) {
                        myIcon = icon_large;
                    }
                    else if (data.features[i].properties[timestamp][0] > uniq_breaks[1] && data.features[i].properties[timestamp][0] <= uniq_breaks[2]) {
                        myIcon = icon_medium;
                    }
                    else{
                        myIcon = icon_small;
                    };
                }
                else if (uniq_breaks.length === 3) {
                    console.log("long 3");
                    if (data.features[i].properties[timestamp][0] > uniq_breaks[1] && data.features[i].properties[timestamp][0] <= uniq_breaks[2]) {
                        myIcon = icon_large;
                    }
                    else {
                        myIcon = icon_medium;
                    }
                }
                else if (uniq_breaks.length === 2) {
                    if (data.features[i].properties[timestamp][0] > uniq_breaks[0] && data.features[i].properties[timestamp][0] <= uniq_breaks[1]) {
                        myIcon = icon_large;
                    }
                }
                // uniq_breaks.length === 1
                else {
                    myIcon = icon_large;
                }
                var weekly_popup = "<b>" + data.features[i].properties.name + " </b><br>" +
                   "<b>" + String(data.features[i].properties[timestamp][0]) +
                   "</b> consultations in week " + timestamp + " 2015<br>" +
                   "<b>Reporting Place</b>: " + String(data.features[i].properties[timestamp][1]) +
                   "<br><b>Partner</b>: " + String(data.features[i].properties[timestamp][2]).toUpperCase() +
                   "<br><b>Type</b>: " + String(data.features[i].properties[timestamp][3]) +
                   "<br><b>Type Facility</b>: " + String(data.features[i].properties[timestamp][4]).toUpperCase();

                var marker = L.marker(new L.LatLng(coords[1], coords[0]), { icon: myIcon, val: data.features[i].properties[timestamp][0] });
                marker.bindPopup(weekly_popup, {'offset': L.point(0,-10)});

                marker.on('mouseover', function (e) {
                    this.openPopup();
                });
                marker.on('mouseout', function (e) {
                    this.closePopup();
                });

                markers.addLayer(marker);
        }
        map.addLayer(markers);
    };
}
 

function createSliderUI(data, timestamps) {
    var sliderControl = L.control({ position: 'bottomleft'} );

    sliderControl.onAdd = function(map) {

        var slider = L.DomUtil.create("input", "range-slider");

        L.DomEvent.addListener(slider, 'mousedown', function(e) { 

            L.DomEvent.stopPropagation(e); 
        });
        $(slider)
        .attr({'type':'range', 'max': timestamps[timestamps.length-1], 'min':timestamps[0], 'step': 1,'value': timestamps[timestamps.length-1]}).on('input change', function() {

            map.removeLayer(markers);
            updatePropSymbols(data, $(this).val().toString());
            donut_chart("code/data/donut_by_ari.json", "weekly", $(this).val(), 'donut1');
            donut_chart("code/data/donut_by_age.json", "weekly", $(this).val(), 'donut2');
            donut_chart("code/data/donut_by_gender.json", "weekly", $(this).val(), 'donut3');
            
            dis_alert_list($(this).val());

            $('output.temporal-legend').removeAttr('id');
            $(".temporal-legend").text('Week ' + this.value);
            if (this.value <= 53) {
                $(".temporal-legend").text('Week ' + this.value + ' 2015');
                semaine_map = this.value + '_2014';
            }   
            else{
                $(".temporal-legend").text('Semaine ' + String(this.value - 53) + ' de 2015');
                semaine_map = String(this.value - 53) + '_2015';
            };
        });
        return slider;
    }
    sliderControl.addTo(map);
    createTemporalLegend(timestamps[timestamps.length-1]);
}

function createTemporalLegend(startTimestamp, step) {
    var temporalLegend = L.control({ position: 'bottomleft' });  
    temporalLegend.onAdd = function(map) {  
        var output = L.DomUtil.create("output", "temporal-legend");
        return output;  
    }
    temporalLegend.addTo(map);  
    if (startTimestamp <= 53) {
        $(".temporal-legend").text('Week ' + startTimestamp + ' 2015');
        semaine_map = startTimestamp + '_2014';
    }
    else{
    $(".temporal-legend").text('Semaine ' + String(startTimestamp - 53) + ' de 2015'); 
    semaine_map = String(startTimestamp - 53) + '_2015';
    };
}

function add_legend() {
    legend = L.control({position: 'bottomright'});
    legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'legend');

        if (uniq_breaks.length !== 0) {
            div.innerHTML = '<i id="legend_cluster_rs"><i id="legend_cluster2_rs"></i></i><span id="text_cluster">Cluster of reporting sites</span></br></br></br><i id="legend_indiv_rs"></i><span>Individual reporting site</span></br><h5>Number of consultations</h5>'

            grades = ['rgba(240,59,32, 1)', "rgba(254,153,41, 1);", "rgba(241, 211, 87, 1)"]
            if (uniq_breaks.length == 4) {
                labels = ['> ' + uniq_breaks[2].toLocaleString(), (uniq_breaks[1] + 1).toLocaleString() + ' - ' + uniq_breaks[2].toLocaleString(),  uniq_breaks[0].toLocaleString() + ' - ' + uniq_breaks[1].toLocaleString()];
            }
            else if (uniq_breaks.length == 3) {
                //labels = [(uniq_breaks[1] + 1).toLocaleString() + ' - ' + uniq_breaks[2].toLocaleString(),  uniq_breaks[0].toLocaleString() + ' - ' + uniq_breaks[1].toLocaleString()];
                labels = ['> ' + uniq_breaks[1].toLocaleString(),  uniq_breaks[0].toLocaleString() + ' - ' + uniq_breaks[1].toLocaleString()];
            }
            else if (uniq_breaks.length == 2) {
                //labels = [uniq_breaks[0].toLocaleString() + ' - ' + uniq_breaks[1].toLocaleString()];
                labels = ['> ' + uniq_breaks[0].toLocaleString()];
            }
            // uniq_breaks.length == 1
            else {
                labels = [uniq_breaks[0].toLocaleString()];
            }

            // loop through our density intervals and generate a label with a colored square for each interval
            for (var i = 0; i < labels.length; i++) {
                div.innerHTML +='<i style="background:' + grades[i] + '"></i>' + labels[i] + '</br>';
            }    
        }
        else{
            div.innerHTML = 'No consultations';
        };
        return div;
    };
    legend.addTo(map);
}

function donut_chart(donut_file, type, week, html_id) {
    d3.json(donut_file,function(error,data) {
    nv.addGraph(function() {
     var chart = nv.models.pieChart()
      .x(function(d) { return d.label })
      .y(function(d) { return d.value })
      //.showLegend(false)
      .showLabels(true)     //Display pie labels
      .labelThreshold(.05)  //Configure the minimum slice size for labels to show up
      .labelType("percent") //Configure what type of data to show in the label. Can be "key", "value" or "percent"
      .donut(true)          //Turn on Donut mode. Makes pie chart look tasty!
      .labelsOutside(true)
      .donutRatio(0.5)     //Configure how big you want the donut hole size to be.
      .valueFormat(d3.format(',f'))
      //.width(60)
      ;

      if (html_id === "donut1") {
        colors = ["#d8b365","#5ab4ac"];
      }
      else if (html_id === "donut2") {
        colors = ["#ef8a62", "#999999"];
      }
      else{
        colors = ["#3288bd", "#d53e4f"];
      };

     chart.color(colors)
     var id;
     if (type === "weekly") {
        id = week - 1;
     }
     // cumul
     else{
        id = week;
     };

     d3.select("#" + html_id + " svg")
        .datum(data[id])
        .transition().duration(350)
        .call(chart);

    return chart;

    });
});
}

// Function to display the lists of diseases and alerts
function dis_alert_list(week) {
    $( ".dis_list" ).empty();
    $( ".alert_list" ).empty();
    var diseases = (function () {
        var json = null;
        $.ajax({
            'async': false,
            'global': false,
            'url': "code/data/disease_list.json",
            'dataType': "json",
            'success': function (data) {
                json = data;
            }
        });
        return json;
    })(); 
    var alerts = (function () {
        var json = null;
        $.ajax({
            'async': false,
            'global': false,
            'url': "code/data/alert_list.json",
            'dataType': "json",
            'success': function (data) {
                json = data;
            }
        });
        return json;
    })(); 

    var dis_week = document.getElementsByClassName("dis_list")[0];
    var alert_week = document.getElementsByClassName("alert_list")[0];
    var i_dis = diseases[week - 1];
    var i_al = alerts[week - 1];
    for(var i = 0; i < i_dis.length; i++) {
        var li = document.createElement("li");
        li.innerHTML = '<span>' + i_dis[i].n + '</span>' + ' ' + i_dis[i].d;
        dis_week.appendChild(li);
    }
    for(var i = 0; i < i_al.length; i++) {
        var li = document.createElement("li");
        li.innerHTML = '<span>' + i_al[i].n + '</span>' + ' ' + i_al[i].d;
        alert_week.appendChild(li);
    }
}

function show_weekly(geojson_file) {
    console.log(geojson_file);
    $("output.temporal-legend").remove();
    $("input.range-slider").remove();
    
    try {
        legend.removeFrom(map);
    }
    catch(err) {  
    }
    $.getJSON(geojson_file, function(data) {
        extractDistrib(data);
        // When I load a layer (disease) I show the last week
        updatePropSymbols(data, timestamps.length-1);   
        createSliderUI(data, timestamps); 
        add_legend();

    });
}

// By default on the map I load all the diseases
show_weekly('code/data/all_per_week.geojson')
// By default I load on the donuts, the data for the last week
donut_chart("code/data/donut_by_ari.json", "weekly", timestamps[timestamps.length-1], 'donut1');
donut_chart("code/data/donut_by_age.json", "weekly", timestamps[timestamps.length-1], 'donut2');
donut_chart("code/data/donut_by_gender.json", "weekly", timestamps[timestamps.length-1], 'donut3');

dis_alert_list(timestamps[timestamps.length-1]);
    
var dropdmenu = L.control({position: 'topright'});
dropdmenu.onAdd = function (map) {
    var div = L.DomUtil.create('div', 'info dropdmenu');
    div.innerHTML = '<select class="form-control choice_disease"><option value="1">All Diseases</option><option value="2">Acumal</option><option value="3">AD</option><option value="4">AFP</option><option value="5">AJS</option><option value="6">AWD</option><option value="7">BD</option><option value="8">Lesh</option><option value="9">LRTI</option><option value="10">MG</option><option value="11">Others</option><option value="12">Skin</option><option value="13">Susp. Dip</option><option value="14">Susp. HF</option><option value="15">Susp. MS</option><option value="16">Susp. NNT</option><option value="17">Susp. Pert</option><option value="18">Susp. Rabies</option><option value="19">Unexp. Fever</option><option value="20">URTI</option></select>';
    div.firstChild.onmousedown = div.firstChild.ondblclick = L.DomEvent.stopPropagation;
    return div;
};
dropdmenu.addTo(map);


$("select.choice_disease").change(
 function () {
  var val=this.value;
    if ($(this).val() == "1") {
        if ($("button.bswitchCW").text() ==="See cumulative data") {
            map.removeLayer(markers);
            show_weekly('code/data/all_per_week.geojson');
        }
        else {
            $("output.temporal-legend").remove();
            $("input.range-slider").remove();
            show_cumulative("code/data/all_cumul.geojson");
        }
    }
    else if ($(this).val() == "2") {
        if ($("button.bswitchCW").text() ==="See cumulative data") {
            map.removeLayer(markers);
            show_weekly('code/data/Acumal_per_week.geojson');
        }
        else {
            $("output.temporal-legend").remove();
            $("input.range-slider").remove();
            show_cumulative("code/data/Acumal_cumul.geojson");
        }
    }
    else if ($(this).val() == "3") {
        if ($("button.bswitchCW").text() ==="See cumulative data") {
            map.removeLayer(markers);
            show_weekly('code/data/Ad_per_week.geojson');
        }
        else {
            $("output.temporal-legend").remove();
            $("input.range-slider").remove();
            show_cumulative("code/data/Ad_cumul.geojson");
        }
    }
    else if ($(this).val() == "4") {
        if ($("button.bswitchCW").text() ==="See cumulative data") {
            map.removeLayer(markers);
            show_weekly('code/data/Afp_per_week.geojson');
        }
        else {
            $("output.temporal-legend").remove();
            $("input.range-slider").remove();
            show_cumulative("code/data/Afp_cumul.geojson");
        }
    }
    else if ($(this).val() == "5") {
        if ($("button.bswitchCW").text() ==="See cumulative data") {
            map.removeLayer(markers);
            show_weekly('code/data/Ajs_per_week.geojson');
        }
        else {
            $("output.temporal-legend").remove();
            $("input.range-slider").remove();
            show_cumulative("code/data/Ajs_cumul.geojson");
        }     
    }
    else if ($(this).val() == "6") {
        if ($("button.bswitchCW").text() ==="See cumulative data") {
            map.removeLayer(markers);
            show_weekly('code/data/Awd_per_week.geojson');
        }
        else {
            $("output.temporal-legend").remove();
            $("input.range-slider").remove();
            show_cumulative("code/data/Awd_cumul.geojson");
        }     
    }
    else if ($(this).val() == "7") {
        if ($("button.bswitchCW").text() ==="See cumulative data") {
            map.removeLayer(markers);
            show_weekly('code/data/Bd_per_week.geojson');
        }
        else {
            $("output.temporal-legend").remove();
            $("input.range-slider").remove();
            show_cumulative("code/data/Bd_cumul.geojson");
        }     
    }
    else if ($(this).val() == "8") {
        if ($("button.bswitchCW").text() ==="See cumulative data") {
            map.removeLayer(markers);
            show_weekly('code/data/Lesh_per_week.geojson');
        }
        else {
            $("output.temporal-legend").remove();
            $("input.range-slider").remove();
            show_cumulative("code/data/Lesh_cumul.geojson");
        }     
    }
    else if ($(this).val() == "9") {
        if ($("button.bswitchCW").text() ==="See cumulative data") {
            map.removeLayer(markers);
            show_weekly('code/data/Lrti_per_week.geojson');
        }
        else {
            $("output.temporal-legend").remove();
            $("input.range-slider").remove();
            show_cumulative("code/data/Lrti_cumul.geojson");
        }     
    }
    else if ($(this).val() == "10") {
        if ($("button.bswitchCW").text() ==="See cumulative data") {
            map.removeLayer(markers);
            show_weekly('code/data/Mg_per_week.geojson');
        }
        else {
            $("output.temporal-legend").remove();
            $("input.range-slider").remove();
            show_cumulative("code/data/Mg_cumul.geojson");
        }     
    }
    else if ($(this).val() == "11") {
        if ($("button.bswitchCW").text() ==="See cumulative data") {
            map.removeLayer(markers);
            show_weekly('code/data/Oth_per_week.geojson');
        }
        else {
            $("output.temporal-legend").remove();
            $("input.range-slider").remove();
            show_cumulative("code/data/Oth_cumul.geojson");
        }     
    }
    else if ($(this).val() == "12") {
        if ($("button.bswitchCW").text() ==="See cumulative data") {
            map.removeLayer(markers);
            show_weekly('code/data/Skin_per_week.geojson');
        }
        else {
            $("output.temporal-legend").remove();
            $("input.range-slider").remove();
            show_cumulative("code/data/Skin_cumul.geojson");
        }     
    }
    else if ($(this).val() == "13") {
        if ($("button.bswitchCW").text() ==="See cumulative data") {
            map.removeLayer(markers);
            show_weekly('code/data/Susp_Dip_per_week.geojson');
        }
        else {
            $("output.temporal-legend").remove();
            $("input.range-slider").remove();
            show_cumulative("code/data/Susp_Dip_cumul.geojson");
        }     
    }
    else if ($(this).val() == "14") {
        if ($("button.bswitchCW").text() ==="See cumulative data") {
            map.removeLayer(markers);
            show_weekly('code/data/Susp_Hf_per_week.geojson');
        }
        else {
            $("output.temporal-legend").remove();
            $("input.range-slider").remove();
            show_cumulative("code/data/Susp_Hf_cumul.geojson");
        }     
    }
    else if ($(this).val() == "15") {
        if ($("button.bswitchCW").text() ==="See cumulative data") {
            map.removeLayer(markers);
            show_weekly('code/data/Susp_Ms_per_week.geojson');
        }
        else {
            $("output.temporal-legend").remove();
            $("input.range-slider").remove();
            show_cumulative("code/data/Susp_Ms_cumul.geojson");
        }     
    }
    else if ($(this).val() == "16") {
        if ($("button.bswitchCW").text() ==="See cumulative data") {
            map.removeLayer(markers);
            show_weekly('code/data/Susp_Nnt_per_week.geojson');
        }
        else {
            $("output.temporal-legend").remove();
            $("input.range-slider").remove();
            show_cumulative("code/data/Susp_Nnt_cumul.geojson");
        }     
    }
    else if ($(this).val() == "17") {
        if ($("button.bswitchCW").text() ==="See cumulative data") {
            map.removeLayer(markers);
            show_weekly('code/data/Susp_Pert_per_week.geojson');
        }
        else {
            $("output.temporal-legend").remove();
            $("input.range-slider").remove();
            show_cumulative("code/data/Susp_Pert_cumul.geojson");
        }     
    }
    else if ($(this).val() == "18") {
        if ($("button.bswitchCW").text() ==="See cumulative data") {
            map.removeLayer(markers);
            show_weekly('code/data/Susp_Rabies_per_week.geojson');
        }
        else {
            $("output.temporal-legend").remove();
            $("input.range-slider").remove();
            show_cumulative("code/data/Susp_Rabies_cumul.geojson");
        }     
    }
    else if ($(this).val() == "19") {
        if ($("button.bswitchCW").text() ==="See cumulative data") {
            map.removeLayer(markers);
            show_weekly('code/data/Unexp_Fever_per_week.geojson');
        }
        else {
            $("output.temporal-legend").remove();
            $("input.range-slider").remove();
            show_cumulative("code/data/Unexp_Fever_cumul.geojson");
        }     
    }
    // value = "20"
    else {
        if ($("button.bswitchCW").text() ==="See cumulative data") {
            map.removeLayer(markers);
            show_weekly('code/data/Urti_per_week.geojson');
        }
        else {
            $("output.temporal-legend").remove();
            $("input.range-slider").remove();
            show_cumulative("code/data/Urti_cumul.geojson");
        }
    }; 
})
// ----------------- End drop down -----------------



var fullZoom = L.control( { position: 'topright' } );
fullZoom.onAdd = function(map) {
var buttonZoom = L.DomUtil.create("button", "bzoom btn btn-default");
$(buttonZoom).append( '<span class="glyphicon glyphicon glyphicon-globe" aria-hidden="true"></span>');

  L.DomEvent.addListener(buttonZoom, 'click', function(e) { 
      map.setView([33.3, 43.5], 6);
  });
  return buttonZoom;
};
fullZoom.addTo(map); 

var switchCW = L.control( { position: 'topright'} );
switchCW.onAdd = function(map) {
var buttonswitchCW = L.DomUtil.create("button", "bswitchCW btn btn-default");
$(buttonswitchCW).text("See cumulative data");
L.DomEvent.addListener(buttonswitchCW, 'click', function(e) { 
var $this = $(this);
// To display the cumulative data
if ($this.text() == "See cumulative data") {
     $this.text('Back to weekly data');
     donut_chart("code/data/donut_by_ari.json", "cumul", timestamps[timestamps.length-1], 'donut1'); 
     donut_chart("code/data/donut_by_age.json", "cumul", timestamps[timestamps.length-1], 'donut2'); 
     donut_chart("code/data/donut_by_gender.json", "cumul", timestamps[timestamps.length-1], 'donut3'); 

     dis_alert_list(35);     

     if ($("select.choice_disease").val() == "1") {
        $("output.temporal-legend").remove();
        $("input.range-slider").remove();
        show_cumulative("code/data/all_cumul.geojson");
    }
    else if ($("select.choice_disease").val() == "2") {
        $("output.temporal-legend").remove();
        $("input.range-slider").remove();
        show_cumulative("code/data/Acumal_cumul.geojson");
    }
    else if ($("select.choice_disease").val() == "3") {
        $("output.temporal-legend").remove();
        $("input.range-slider").remove();
        show_cumulative("code/data/Ad_cumul.geojson");
    }
    else if ($("select.choice_disease").val() == "4") {
        $("output.temporal-legend").remove();
        $("input.range-slider").remove();
        show_cumulative("code/data/Afp_cumul.geojson");
    }
    else if ($("select.choice_disease").val() == "5") {
        $("output.temporal-legend").remove();
        $("input.range-slider").remove();
        show_cumulative("code/data/Ajs_cumul.geojson");
    }
    else if ($("select.choice_disease").val() == "6") {
        $("output.temporal-legend").remove();
        $("input.range-slider").remove();
        show_cumulative("code/data/Awd_cumul.geojson");
    }
    else if ($("select.choice_disease").val() == "7") {
        $("output.temporal-legend").remove();
        $("input.range-slider").remove();
        show_cumulative("code/data/Bd_cumul.geojson");
    }
    else if ($("select.choice_disease").val() == "8") {
        $("output.temporal-legend").remove();
        $("input.range-slider").remove();
        show_cumulative("code/data/Lesh_cumul.geojson");
    }
    else if ($("select.choice_disease").val() == "9") {
        $("output.temporal-legend").remove();
        $("input.range-slider").remove();
        show_cumulative("code/data/Lrti_cumul.geojson");
    }
    else if ($("select.choice_disease").val() == "10") {
        $("output.temporal-legend").remove();
        $("input.range-slider").remove();
        show_cumulative("code/data/Mg_cumul.geojson");
    }
    else if ($("select.choice_disease").val() == "11") {
        $("output.temporal-legend").remove();
        $("input.range-slider").remove();
        show_cumulative("code/data/Oth_cumul.geojson");
    }
    else if ($("select.choice_disease").val() == "12") {
        $("output.temporal-legend").remove();
        $("input.range-slider").remove();
        show_cumulative("code/data/Skin_cumul.geojson");
    }
    else if ($("select.choice_disease").val() == "13") {
        $("output.temporal-legend").remove();
        $("input.range-slider").remove();
        show_cumulative("code/data/Susp_Dip_cumul.geojson");
    }
    else if ($("select.choice_disease").val() == "14") {
        $("output.temporal-legend").remove();
        $("input.range-slider").remove();
        show_cumulative("code/data/Susp_Hf_cumul.geojson");
    }
    else if ($("select.choice_disease").val() == "15") {
        $("output.temporal-legend").remove();
        $("input.range-slider").remove();
        show_cumulative("code/data/Susp_Ms_cumul.geojson");
    }
    else if ($("select.choice_disease").val() == "16") {
        $("output.temporal-legend").remove();
        $("input.range-slider").remove();
        show_cumulative("code/data/Susp_Nnt_cumul.geojson");
    }
    else if ($("select.choice_disease").val() == "17") {
        $("output.temporal-legend").remove();
        $("input.range-slider").remove();
        show_cumulative("code/data/Susp_Pert_cumul.geojson");
    }
    else if ($("select.choice_disease").val() == "18") {
        $("output.temporal-legend").remove();
        $("input.range-slider").remove();
        show_cumulative("code/data/Susp_Rabies_cumul.geojson");
    }
    else if ($("select.choice_disease").val() == "19") {
        $("output.temporal-legend").remove();
        $("input.range-slider").remove();
        show_cumulative("code/data/Unexp_Fever_cumul.geojson");
    }
    // = 20
    else  {
        $("output.temporal-legend").remove();
        $("input.range-slider").remove();
        show_cumulative("code/data/Urti_cumul.geojson");
    }

} 
// To go back to the weekly data
else {
     $this.text("See cumulative data");
     donut_chart("code/data/donut_by_ari.json", "weekly", timestamps[timestamps.length-1], 'donut1');
     donut_chart("code/data/donut_by_age.json", "weekly", timestamps[timestamps.length-1], 'donut2');
     donut_chart("code/data/donut_by_gender.json", "weekly", timestamps[timestamps.length-1], 'donut3');

     dis_alert_list(timestamps[timestamps.length-1]);

     if ($("select.choice_disease").val() == "1") {
        map.removeLayer(markers);
        show_weekly('code/data/all_per_week.geojson');    
    }
    else if ($("select.choice_disease").val() == "2") {
        map.removeLayer(markers);
        show_weekly('code/data/Acumal_per_week.geojson');
    }
    else if ($("select.choice_disease").val() == "3") {
        map.removeLayer(markers);
        show_weekly('code/data/Ad_per_week.geojson');
    }
    else if ($("select.choice_disease").val() == "4") {
        map.removeLayer(markers);
        show_weekly('code/data/Afp_per_week.geojson');
    }
    else if ($("select.choice_disease").val() == "5") {
        map.removeLayer(markers);
        show_weekly('code/data/Ajs_per_week.geojson');
    }
    else if ($("select.choice_disease").val() == "6") {
        map.removeLayer(markers);
        show_weekly('code/data/Awd_per_week.geojson');
    }
    else if ($("select.choice_disease").val() == "7") {
        map.removeLayer(markers);
        show_weekly('code/data/Bd_per_week.geojson');
    }
    else if ($("select.choice_disease").val() == "8") {
        map.removeLayer(markers);
        show_weekly('code/data/Lesh_per_week.geojson');
    }
    else if ($("select.choice_disease").val() == "9") {
        map.removeLayer(markers);
        show_weekly('code/data/Lrti_per_week.geojson');
    }
    else if ($("select.choice_disease").val() == "10") {
        map.removeLayer(markers);
        show_weekly('code/data/Mg_per_week.geojson');
    }
    else if ($("select.choice_disease").val() == "11") {
        map.removeLayer(markers);
        show_weekly('code/data/Oth_per_week.geojson');;
    }
    else if ($("select.choice_disease").val() == "12") {
        map.removeLayer(markers);
        show_weekly('code/data/Skin_per_week.geojson');
    }
    else if ($("select.choice_disease").val() == "13") {
        map.removeLayer(markers);
        show_weekly('code/data/Susp_Dip_per_week.geojson');
    }
    else if ($("select.choice_disease").val() == "14") {
        map.removeLayer(markers);
        show_weekly('code/data/Susp_Hf_per_week.geojson');
    }
    else if ($("select.choice_disease").val() == "15") {
        map.removeLayer(markers);
        show_weekly('code/data/Susp_Ms_per_week.geojson');
    }
    else if ($("select.choice_disease").val() == "16") {
        map.removeLayer(markers);
        show_weekly('code/data/Susp_Nnt_per_week.geojson');
    }
    else if ($("select.choice_disease").val() == "17") {
        map.removeLayer(markers);
        show_weekly('code/data/Susp_Pert_per_week.geojson');
    }
    else if ($("select.choice_disease").val() == "18") {
        map.removeLayer(markers);
        show_weekly('code/data/Susp_Rabies_per_week.geojson');
    }
    else if ($("select.choice_disease").val() == "19") {
        map.removeLayer(markers);
        show_weekly('code/data/Unexp_Fever_per_week.geojson');
    }
    // = 20
    else {
        map.removeLayer(markers);
        show_weekly('code/data/Urti_per_week.geojson');
    }
};
});
return buttonswitchCW;
       };
switchCW.addTo(map);

var sh_legend = L.control( { position: 'topright' } );
sh_legend.onAdd = function(map) {
var buttonLegend = L.DomUtil.create("button", "btlegend btn btn-default");
$(buttonLegend).append( '<span class="glyphicon glyphicon glyphicon-list-alt" aria-hidden="true"></span>');

  L.DomEvent.addListener(buttonLegend, 'click', function(e) { 
    if ($("div.legend").is(":visible")) {
        $("div.legend").hide();
    }
    else{
        $("div.legend").show();
    };
      
  });
  return buttonLegend;
};
sh_legend.addTo(map); 

var switchOsm = L.control( { position: 'topright' } );
switchOsm.onAdd = function(map) {
var buttonSwitch = L.DomUtil.create("button", "bswitch btn btn-default");
//$(buttonSwitch).text("OpenStreetMap");
$(buttonSwitch).append( '<span class=" glyphicon glyphicon glyphicon-menu-hamburger" aria-hidden="true"></span>');
  L.DomEvent.addListener(buttonSwitch, 'click', function(e) { 

    if (map.hasLayer(OpenStreetMap_HOT) == true) {
        map.removeLayer(OpenStreetMap_HOT);
        map.addLayer(baseLayers);
        
        hprovs.bringToBack();
        hdists.bringToBack();
        countries.bringToBack();            
        $("em").show();
    }
    else{
        map.addLayer(OpenStreetMap_HOT);
        $("em").hide();
        map.removeLayer(baseLayers);
    };
  });
  return buttonSwitch;
};
switchOsm.addTo(map); 

 // code for main chart
 d3.json("code/data/linebart_chart.json",function(error,data) {
            nv.addGraph(function() {
              var chart = nv.models.linePlusBarChart()
                    .margin({top: 30, right: 60, bottom: 50, left: 70})
                    //.margin({top: 0, right: 20, bottom: 0, left: 40})
                    //We can set x data accessor to use index. Reason? So the bars all appear evenly spaced.
                    .x(function(d,i) {return i })
                    .y(function(d,i) {return d[1] })
                    // To work with this commented and customised for week numbers 2016
                    .focusEnable(false) // Remove the focus chart bellow the main one
                    ;
                    
              // Custom the tooltip
              chart.tooltip.contentGenerator(function (key) {
                    //if the serie is the reporting sites
                    if(key.hasOwnProperty('point')){
                        etiquette = '<b>Week ' + key.point[0] + '</b><table><tr><td class="legend-color-guide"><div style="background:'+ key.point.color + ';"></div></td><td>' + key.point[1] + ' Reporting Sites</td></table>'
                    }
                    // the total consultations serie
                    else {
                        etiquette = '<b>Week ' + key.data[0] + '</b><table><tr><td class="legend-color-guide"><div style="background:'+ key.color + ';"></div></td><td>' + key.data[1].toLocaleString() + ' Total Consulations'
                    }        
                    return etiquette;
               });

              // Change the y fomain for the reporting site serie to start at 0 and not at ymin
              chart.forceY(0);

              // To custom the x-axis label. 
              chart.xAxis
              .axisLabel("Weeks")
              .tickFormat(function(d){
                            return d + 1
                        });

              chart.y1Axis
                  .tickFormat(d3.format(',f'));

              chart.y2Axis
                  .tickFormat(d3.format(',f'));

              // To deactivte onclick legend
              /*for (var property in chart.legend.dispatch) {
                    chart.legend.dispatch[property] = function() { };
                }*/

              d3.select('#chart_main svg')
                .datum(data)
                .transition()
                .duration(0)
                .call(chart);

              nv.utils.windowResize(chart.update);
              return chart;
          });
    });

function graph_trends(json_file) {
    $( "#chart_gtrend svg" ).empty();
    d3.json(json_file, function(data) {
        nv.addGraph(function() {
        var chart = nv.models.lineChart()
                      //.margin({top: 0, right: 15, bottom: 75, left: 60})
                      .x(function(d,i) { return i })
                      .y(function(d,i) {return d[1] });

         // Custom the tooltip
          chart.tooltip.contentGenerator(function (key) {
                etiquette = '<b>Week ' + key.point[0] + ' - ' + key.series[0]["key"] + '</b><table><tr><td class="legend-color-guide"><div style="background:'+ key.point.color + ';"></div></td><td>' + key.point[1] + '%</td></table>'
                return etiquette;
           });

         // To custom the x-axis label. 
         chart.xAxis
            .axisLabel("Weeks")
            .tickFormat(function(d){
                          return d + 1
                      });
        chart.yAxis
            .axisLabel("Percentage")
            .tickFormat(d3.format(',.2f'));

        chart.forceY(0);

        d3.select('#chart_gtrend svg')
            .datum(data)
            .call(chart);

        nv.utils.windowResize(chart.update);
        return chart;
      });
    });
}
// When the page loads, I display the chart for both IDPs and Refugees
graph_trends('code/data/chart_all.json');

$("select#trends").change(
 function () {
  var val=this.value;
  // IDPs and Refugees
  if ($(this).val() == "1") {
    graph_trends('code/data/chart_all.json');
  }
  // Just IDPs
  else if ($(this).val() == "2") {
    graph_trends('code/data/chart_idps.json');
  }
  // Just Refugees
  else{
    graph_trends('code/data/chart_refugees.json');
  };
});


// close ready(function()
});
</script> 

    
        <script src="code/src/bootstrap-3.3.4-dist/js/bootstrap.min.js"></script> 
    

     
<script>  
    $(function () 
    { $(".btlegend").tooltip({placement : 'bottom', title: 'Show / Hide Legend', container: 'body'});  
    }); 

    $(function ()  
    { $(".bzoom").tooltip({placement : 'auto', title: 'Full Extent', container: 'body'});  
    }); 

    $(function ()  
    { $(".bswitch").tooltip({placement : 'auto', title: 'Show / Hide  OpenStreetMap background', container: 'body'});  
    }); 
</script>

  </body>
</html>